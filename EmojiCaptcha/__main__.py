#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os
import random
from typing import Dict
from PIL import Image
import uuid
import logging
from EmojiCaptcha.emojis_map import emojis_index


DATA_DIR = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'emojis')
try:
    os.mkdir("cache")
except OSError:
    pass

class Captcha:
    def __init__(self, file_name=None, background=None):
        """
        Optional **args

        file_name[str]: custom file name for generating.

        background[str]: background image file path for captcha.

        ---------------------------------------------------------

        Return type -----> dict
        """

        self.file_name = file_name if file_name else str(uuid.uuid4().hex)
        self.background = background if background else os.path.join(DATA_DIR, 'background.png')


    def generate(self) -> dict():
        "Main function to Generate Captcha"
        try:
            background = Image.open(self.background)
            paste_image_list = list()
            emoji_names = list()
            supported_emojis = ['ğŸƒ', 'ğŸ¤', 'ğŸ¥', 'ğŸ¨', 'ğŸ©', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ±', 'ğŸ²', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸ¾', 'ğŸ€', 'ğŸ†', 'ğŸˆ', 'ğŸ‰', 'ğŸ', 'ğŸ“', 'ğŸ’ ', 'ğŸ’¡', 'ğŸ’£', 'ğŸ’¨', 'ğŸ’¸', 'ğŸ’»', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“Š', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“¡', 'ğŸ“¢', 'ğŸ“£', 'ğŸ“¦', 'ğŸ“¹', 'ğŸ“º', 'ğŸ“»', 'ğŸ“¼', 'ğŸ“½', 'ğŸ–¥', 'ğŸ–¨', 'ğŸ–²', 'ğŸ—‚', 'ğŸ—ƒ', 'ğŸ—„', 'ğŸ—œ', 'ğŸ—', 'ğŸ—¡', 'ğŸš§', 'ğŸš¨', 'ğŸ›’', 'ğŸ› ', 'ğŸ›¢', 'ğŸ§€', 'ğŸŒ­', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ½', 'ğŸŒ¾', 'ğŸŒ¿', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ', 'ğŸŸ', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸº', 'ğŸ»', 'ğŸ¼', 'ğŸ½', 'ğŸ¾', 'ğŸ¿', 'ğŸŠ', 'ğŸ‹', 'ğŸ', 'ğŸ', 'ğŸš', 'ğŸ›', 'ğŸ', 'ğŸŒ', 'ğŸ', 'ğŸ', 'ğŸš', 'ğŸ›', 'ğŸ', 'ğŸ', 'ğŸŸ', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ»', 'ğŸ¼', 'ğŸ¿', 'ğŸ‘›', 'ğŸ‘œ', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Ÿ', 'ğŸ’Š', 'ğŸ’‹', 'ğŸ’', 'ğŸ’', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ”ª', 'ğŸ”«', 'ğŸ”¬', 'ğŸ”­', 'ğŸ”®', 'ğŸ•¯', 'ğŸ–Š', 'ğŸ–‹', 'ğŸ–Œ', 'ğŸ–', 'ğŸ¥š', 'ğŸ¥›', 'ğŸ¥œ', 'ğŸ¥', 'ğŸ¥', 'ğŸ¦Š', 'ğŸ¦‹', 'ğŸ¦Œ', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦', 'ğŸŒ€', 'ğŸŒ‚', 'ğŸŒ‘', 'ğŸŒ•', 'ğŸŒ¡', 'ğŸŒ¤', 'â›…ï¸', 'ğŸŒ¦', 'ğŸŒ§', 'ğŸŒ¨', 'ğŸŒ©', 'ğŸŒ°', 'ğŸŒ±', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¶', 'ğŸŒ·', 'ğŸŒ¸', 'ğŸŒ¹', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ…', 'ğŸ†', 'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ”', 'ğŸ•', 'ğŸ–', 'ğŸ—', 'ğŸ˜', 'ğŸ™', 'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©', 'ğŸ°', 'ğŸ±', 'ğŸ²', 'ğŸ´', 'ğŸµ', 'ğŸ¶', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸˆ', 'ğŸ‰', 'ğŸ’', 'ğŸ“', 'ğŸ™', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ…', 'ğŸ†', 'ğŸ‡', 'ğŸ•', 'ğŸ‰', 'ğŸ“', 'ğŸ–', 'ğŸ—', 'ğŸ˜', 'ğŸ™', 'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©', 'ğŸ°', 'ğŸ±', 'ğŸ´', 'ğŸµ', 'ğŸ¶', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸ‘\u200dğŸ—¨', 'ğŸ‘‘', 'ğŸ‘’', 'ğŸ‘ ', 'ğŸ‘¡', 'ğŸ‘¢', 'ğŸ’„', 'ğŸ’ˆ', 'ğŸ”—', 'ğŸ”¥', 'ğŸ”¦', 'ğŸ”§', 'ğŸ”¨', 'ğŸ”©', 'ğŸ”°', 'ğŸ”±', 'ğŸ•°', 'ğŸ•¶', 'ğŸ•¹', 'ğŸ–‡', 'ğŸš€', 'ğŸ¤–', 'ğŸ¥€', 'ğŸ¥', 'ğŸ¥‚', 'ğŸ¥ƒ', 'ğŸ¥', 'ğŸ¥‘', 'ğŸ¥’', 'ğŸ¥“', 'ğŸ¥”', 'ğŸ¥•', 'ğŸ¥–', 'ğŸ¥—', 'ğŸ¥˜', 'ğŸ¥™', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦‚', 'ğŸ¦ƒ', 'ğŸ¦„', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦‡', 'ğŸ¦ˆ', 'ğŸ¦‰', 'ğŸ¦', 'ğŸ¦‘', 'â­ï¸', 'â°', 'â²', 'âš ï¸', 'âš¡ï¸', 'âš°ï¸', 'âš½ï¸', 'âš¾ï¸', 'â›„ï¸', 'â›…ï¸', 'â›ˆ', 'â›', 'â›“', 'âŒšï¸', 'â˜ï¸', 'âšœï¸', 'âœï¸', 'âŒ¨ï¸', 'â˜ï¸', 'â˜ƒï¸', 'â˜„ï¸', 'â˜•ï¸', 'â˜˜ï¸', 'â˜ ï¸', 'â™¨ï¸', 'âš’', 'âš”ï¸', 'âš™ï¸', 'âœˆï¸', 'âœ‰ï¸', 'âœ’ï¸']
            r = random.random()
            random.shuffle(supported_emojis, lambda: r)
            r = random.random()
            random.shuffle(supported_emojis, lambda: r)

            for i in range(6):
                emoji_names.append(supported_emojis[i])
                paste_image_list.append((os.path.join(DATA_DIR, emojis_index.get(supported_emojis[i]) + ".png")))

            position = [(20, 20), (180, 20), (310, 20), (20, 160), (180, 160), (310, 160)]

            for i in range(len(paste_image_list)):
                img = Image.open(paste_image_list[i]).rotate(random.randint(0, 360), resample=Image.BICUBIC, expand=True)
                img.thumbnail((200, 200), Image.ANTIALIAS)
                background.paste(img, (position[i]), img)
                
            emoji_captcha_path = os.path.join("cache", f"{self.file_name}.png")
            background.save(emoji_captcha_path, "PNG", quality=100)
            return {"answer": emoji_names, "captcha": emoji_captcha_path, "is_error": False}
        except Exception as e:
            logging.exception(e)
            return {"is_error": True}

